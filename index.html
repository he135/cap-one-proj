<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8"/>
    <title>Looking to host Airbnb guests?</title>
    <!--<link href="style.css" rel="stylesheet" type="text/css"/>-->
    <style>
        #map {
            height: 400px;
            width: 100%;
            background-color: grey;
        }
        /* #title {
            font-size: 6;
        } */
        body {
            color: #1D4482;
            font-size: 2;
            font-weight: bold;
            font-family: Arial;
        }
        .notBold {
            font-weight: normal;
        }
    </style>
    <!--<script src="map.js"></script>-->
</head>

<body>
    <h1>Looking to host Airbnb guests?</h1>

    <p class="notBold"> Select the button below to view the most popular Airbnb host homes. The homes
        with more reviews will have a higher opacity than those with less reviews. </p>
    <input id="numReviews" type="button" value="Number of Reviews" />


    <p class="notBold"> Input a minimum rating score (0-100) to view the most highly rated Airbnb host
        homes (marked with a gold star). (Might take a while to load.) </p>
    <form id="btn2form" action="/action_page.php">
        <input type="text" name="hRev" value="100">
    </form>
    <input id="highestReviews" type="button" value="Highest Reviews"/>


    <p class="notBold"> The most recently reviewed homes are most likely the most recently visted homes.
        Input a date to see which homes have been reviewed most recently from that date and on. </p>
    <form id="btn3form_month">
        Month: <input type="text" name="month" value="1">
    </form>
    <form id="btn3form_day">
        Day: <input type="text" name="day" value="1">
    </form>
    <form id="btn3form_year">
        Year: <input type="text" name="year" value="2017">
    </form>
    <input id="latestReview" type="button" value="Most Recent Reviews"/> <!--add field -->
    
    <script>
        numReviews = false;
        highestReviews = false;
        latestReview = false;
        document.getElementById("numReviews").onclick = function () { //anonymous func
            numReviews = true;
            reInitMap();
        };

        document.getElementById("highestReviews").onclick = function() {
            highestReviews = true;
            reInitMap();
        };

        document.getElementById("latestReview").onclick = function() {
            latestReview = true;
            reInitMap();
        }


        function reInitMap() {
            // console.log(numReviews);
            // console.log(highestReviews);
            // console.log(latestReview);
            var uluru = new google.maps.LatLng(37.7749, -122.4194);
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: uluru
            });

            $.getJSON('/listings', function (listings) { //jquery
                //console.log('got inside jquery');
                window.eqfeed_callback(listings);
            });

            window.eqfeed_callback = function (results) {
                //console.log('got inside window function');

                //for numReviews:
                var maxNoReviews = parseInt(results[0].number_of_reviews);
                //console.log(maxNoReviews);
                for (var i = 1; i<results.length; i++) {
                    if (parseInt(results[i].number_of_reviews) > maxNoReviews) {
                        maxNoReviews = parseInt(results[i].number_of_reviews);
                    }
                }
                //console.log(maxNoReviews);
                var increment = 1/maxNoReviews;


                //for highestReviews:
                var goldStar = {
                    path: 'M 125,5 155,90 245,90 175,145 200,230 125,180 50,230 75,145 5,90 95,90 z',
                    fillColor: 'gold',
                    fillOpacity: 0.8,
                    scale: .1,
                    strokeColor: 'black',
                    strokeWeight: 1
                };
                var h = document.getElementById("btn2form");


                //for latestReview:
                var ly = document.getElementById("btn3form_year");
                var lm = document.getElementById("btn3form_month");
                var ld = document.getElementById("btn3form_day");
                var inputDate = (parseInt(ly.elements[0].value)*10000) + (parseInt(lm.elements[0].value)
                    *100) + parseInt(ld.elements[0].value);
                //console.log(inputDate);


                for (var i = 0; i < results.length; i++) {

                    var lat = results[i].latitude;
                    var long = results[i].longitude;
                    var latLong = new google.maps.LatLng(lat, long);

                    //for numReviews:
                    var opac;
                    if (numReviews) {
                        opac = results[i].number_of_reviews*increment; //adjusts opacity of each marker
                    } else {
                        opac = 1;
                    }

                    //for highestReviews:
                    var ico = ""; //expects string
                    if (highestReviews) {
                        if (results[i].review_scores_rating == "") {
                            opac = 0;
                        }
                        if (parseInt(results[i].review_scores_rating) >= parseInt(h.elements[0].value)) {
                            ico = goldStar;
                        }
                    }

                    var marker = new google.maps.Marker({
                        position: latLong,
                        opacity: opac,
                        icon: ico,
                        map: map
                    });

                    //for latestReview:
                    //var anim = null;
                    if (latestReview) {
                        var latestRevDate = results[i].last_review;
                        latestRevDate = parseInt(latestRevDate.replace(/-/g,""));
                        //console.log(latestRevDate);
                        if (latestRevDate >= inputDate) {
                            marker.setAnimation(google.maps.Animation.BOUNCE);
                        }
                    }
                }
            }
        }
    </script>

    
    <div id="map"></div>

    <script>
    var map;

    function initMap() {
         //var uluru = {lat: 35.913, lng: -79.056};
         var uluru = new google.maps.LatLng(37.7749,-122.4194);
         map = new google.maps.Map(document.getElementById('map'), {
             zoom: 16,
             center: uluru
         });

        $.getJSON('/listings', function (listings) { //jquery
            window.eqfeed_callback(listings);
        });
    }

     window.eqfeed_callback = function(results) {
        //for (var i = 0; i < results.features.length; i++) {
        for (var i = 0; i < results.length; i++) {

             var lat = results[i].latitude;
             var long = results[i].longitude;
             //var coords = results.features[i].geometry.coordinates;
             //var latLong = new google.maps.LatLng(coords[1], coords[0]);
             var latLong = new google.maps.LatLng(lat,long);

             var marker = new google.maps.Marker({
                 position: latLong,
                 map: map
             });
        }
     }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6dPt6OH2XEBc08IrB-uT9NB5il2CTY54&callback=initMap">
    </script>

    <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>

    <p>Price Listing:</p>
    <p class="notBold"> Enter your coordinates (latitude and longitude) and
        we'll give you an estimate of your average weekly income.</p>

    <form id="form1" action="/action_page.php">
        Latitude (&#176;): <input type="text" name="lat" value="37.775">
        Longitude (&#176;): <input type="text" name="long" value="122.419"><br><br>
    </form>

    <button onclick="priceFunc()">Submit</button>

    <p id="display"></p> <!--output will display here-->

    
    <script>
    function priceFunc() {
        var x = document.getElementById("form1"); //inputs will be put into array
        var text = "";
        var avgPrice;
        /*
        for (var i = 0; i < x.length; i++) {
            console.log(x.elements[i].value);
        }
        */
        

        $.getJSON('/listings', function (listings) {
            var closeArray = []; //array of values
            var closeArrayIdx = []; //array of IDX of values
            for (var i = 0; i < listings.length; i++) {
                var latDist = listings[i].latitude - parseFloat(x.elements[0].value);
                var longDist = listings[i].longitude - parseFloat(x.elements[1].value);
                var distance = Math.sqrt(Math.pow(latDist,2) + Math.pow(longDist,2));

                if (closeArray.length<30) {
                    closeArray.push(distance);
                    closeArrayIdx.push(i);
                } else {
                    var max = closeArray.reduce(function(a, b) {
                        return Math.max(a, b);
                    });
                    var maxIdx = closeArray.indexOf(max);

                    // console.log(distance);
                    // console.log(max);
                    // console.log(maxIdx);

                    if (distance < max) {
                        closeArray.splice(maxIdx,1);
                        closeArray.push(distance);

                        closeArrayIdx.splice(maxIdx,1);
                        closeArrayIdx.push(i);
                    }
                }
            }/*for (var i = 0; i < closeArrayIdx.length; i++) {
                    console.log(closeArrayIdx[i]);
             }*/ //successful

            var totalPrice = 0;
            for (var i = 0; i < closeArrayIdx.length; i++) {
                var price;
                var idx = closeArrayIdx[i];
                if (listings[idx].weekly_price != "") { //"", not null
                    //console.log('reached if');
                    price = listings[idx].weekly_price;
                    price = price.replace(/[$,]+/g,"");
                    price = parseFloat(price);
                } else {
                    //console.log('reached else');
                    price = listings[idx].price;
                    price = price.replace(/[$,]+/g,"");
                    price = 7.0*parseFloat(price);
                }
                //console.log(price);
                totalPrice += price;
            }

            avgPrice = totalPrice/closeArrayIdx.length;
            //console.log(avgPrice);
            text += parseFloat(Math.round(avgPrice * 100) / 100).toFixed(2);
            document.getElementById("display").innerHTML = "$" + text;
        });
    }
    </script>

    <p>How much should I charge my guests?</p>
    <p class="notBold">Enter your coordinates below and we'll give you a suggestion of what price
        per night will yield maximum bookings.</p>

    <form id="form2" action="/action_page.php">
        Latitude (&#176;): <input type="text" name="lat" value="37.775">
        Longitude (&#176;): <input type="text" name="long" value="122.419"><br><br>
    </form>

    <button onclick="bookFunc()">Submit</button>

    <p id="display2"></p>

    <script>
    function bookFunc() {
        var y = document.getElementById("form2"); //inputs will be put into array
        var text2;

        $.getJSON('/listings', function (listings) {
            var closeArray = []; //array of values
            var closeArrayIdx = []; //array of IDX of values
            for (var i = 0; i < listings.length; i++) {
                var latDist = listings[i].latitude - parseFloat(y.elements[0].value);
                var longDist = listings[i].longitude - parseFloat(y.elements[1].value);
                var distance = Math.sqrt(Math.pow(latDist,2) + Math.pow(longDist,2));

                if (closeArray.length<30) {
                    closeArray.push(distance);
                    closeArrayIdx.push(i);
                } else {
                    var max = closeArray.reduce(function(a, b) {
                        return Math.max(a, b);
                    });
                    var maxIdx = closeArray.indexOf(max);

                    if (distance < max) {
                        closeArray.splice(maxIdx,1);
                        closeArray.push(distance);

                        closeArrayIdx.splice(maxIdx,1);
                        closeArrayIdx.push(i);
                    }
                }
            }

            //find which idx of closeArrayIdx yields highest no. reviews
            //take into account same no. reviews
            //var highRevArray = [];
            var maxRev = parseInt(listings[closeArrayIdx[0]].number_of_reviews);
            var maxRevIdx = [];
            maxRevIdx.push(0);
            for (var i = 1; i < closeArrayIdx.length; i++) {
                var currNoRev = parseInt(listings[closeArrayIdx[i]].number_of_reviews);
                //console.log(currNoRev);
                if (currNoRev === maxRev) {
                    // console.log("===");
                    // console.log("current max no. reviews: " + currNoRev);
                    // console.log("the index: " + closeArrayIdx[i]);
                    // console.log("size before: " + maxRevIdx.length);
                    maxRevIdx.push(closeArrayIdx[i]);
                    // console.log("size after: " + maxRevIdx.length);
                }
                if (currNoRev > maxRev) {
                    // console.log(">")
                    // console.log("current max no. reviews: " + currNoRev);
                    // console.log("the index: " + closeArrayIdx[i]);
                    // console.log("size before: " + maxRevIdx.length);
                    for (var i = 0; i<maxRevIdx.length; i++) {
                        maxRevIdx = [];
                    }
                    // console.log("size after: " + maxRevIdx.length);
                    maxRevIdx.push(closeArrayIdx[i]);
                    maxRev = currNoRev;
                }
            }

            // for (var i = 0; i < maxRevIdx.length; i++) {
            //     console.log(i + ": " + maxRevIdx[i]);
            // }

            if (maxRevIdx.length === 1) {
                var price = listings[maxRevIdx[0]].price;
                price = price.replace(/[$,]+/g,"");
                text2 = "The most reviewed Airbnb host home in your area charges $" + 
                parseFloat(Math.round(price * 100) / 100).toFixed(2) + " per night.";
            } else {
                var totalPrice = 0.0;
                for (var i = 0; i < maxRevIdx.length; i++) {
                    totalPrice += parseFloat(listings[maxRevIdx[i]].price.replace(/[$,]+/g,""));
                    //console.log(totalPrice);
                }
                var avgPrice = totalPrice/maxRevIdx.length;
                // console.log(totalPrice);

                text2 = "There are " + maxRevIdx.length + " Airbnb host homes in your area that have" +
                " the most reviews. On average, they charge $" + parseFloat(Math.round(avgPrice * 100)
                /100).toFixed(2) + ".";
            }
            document.getElementById("display2").innerHTML = text2;
        });
    }
    </script>

</body>

</html>